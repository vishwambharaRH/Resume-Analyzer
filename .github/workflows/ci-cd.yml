# ---------------------------------------------------------
# CI/CD Pipeline for Dynamic Resume Analyzer
# Runs on pushes & PRs to main/develop
# Includes Build â†’ Test â†’ Coverage â†’ Lint â†’ Security â†’ Deploy
# ---------------------------------------------------------

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Global environment variables used across jobs
# USE_REAL_GRAMMAR disabled inside CI for deterministic behavior

env:
  # Auto grammar mode detection
  USE_REAL_GRAMMAR: ${{ github.event_name != 'push' && github.event_name != 'pull_request' }}
  GITHUB_ACTIONS: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}
  CI: true

jobs:
  # =====================================================
  #  BUILD STAGE - installs dependencies & builds frontend
  # =====================================================
 
# Checkout repository with full history
# Install backend dependencies
# Install frontend dependencies using npm ci for clean reproducible builds
# Build Vite/React frontend
# Upload built frontend as artifact (used later for deployment package)

  build:
    name: Build Stage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Backend Build ----------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install Cairo system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpng-dev

      - name: Install backend dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ---------- Frontend Build ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      # ---------- Upload Frontend Build Artifact ----------
      - name: Upload Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/

  # =====================================================
  #  TEST STAGE - runs unit, integration, system tests
  # =====================================================

# Install test dependencies including pytest, coverage, html reporting
# Verify grammar engine/action verb engine runs properly on CI
# Run unit tests with coverage threshold enforced
# Run integration tests
# Run system tests
# Build & test frontend (only if test directory exists)
# Generate JUnit & HTML test reports for artifact packaging

  test:
    name: Test Stage
    runs-on: ubuntu-latest
    needs: build
    env:
      USE_REAL_GRAMMAR: "false"
      GITHUB_ACTIONS: "true"
      CI: "true"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Backend Tests ----------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Cairo system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpng-dev pkg-config python3-dev

      - name: Install test dependencies
        run: pip install -r requirements.txt pytest pytest-cov pytest-html pytest-mock spacy  # âœ… Added spacy

      # Grammar & Action Verb Engine Verification (NEW)
      - name: Verify Grammar and Action Verb Engines
        run: |
          echo "Running Grammar & Action Verb Engine verification..."
          python - << 'EOF'
          from src.core.grammar_engine import USE_REAL_GRAMMAR, IS_CI
          from src.core.action_verbs import ActionVerbEngine
          print(f"USE_REAL_GRAMMAR={USE_REAL_GRAMMAR}, IS_CI={IS_CI}")
          try:
              engine = ActionVerbEngine()
              print("âœ… Action Verb Engine initialized successfully")
              text = "I did backend work and helped build an API."
              result = engine.suggest(text)
              print("Weak verbs found:", result.get("found", []))
              print("Suggestions:", result.get("suggestions", []))
          except Exception as e:
              print("âŒ Action Verb Engine failed:", e)
          EOF

      - name: Run Unit Tests (with coverage enforcement)
        run: pytest tests/unit --cov=src --cov-fail-under=75 --disable-warnings -q

      - name: Run Integration Tests
        run: pytest tests/integration --disable-warnings -q

      - name: Run System Tests
        run: pytest tests/system --disable-warnings -q

      # ---------- Frontend Tests ----------
      - name: Setup Node.js for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: "20"
 
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run Frontend Tests (Skip if none)
        working-directory: ./frontend
        run: |
          npm run build --if-present
          if [ -d "__tests__" ]; then
            npm test -- --watchAll=false
          else
            echo "No frontend tests found, skipping..."
          fi

      # ---------- Test Reports ----------
      - name: Generate Pytest Reports (JUnit + HTML)
        run: |
          pytest --junitxml=test-results.xml --html=pytest-report.html --self-contained-html
      - name: Upload Pytest Reports
        uses: actions/upload-artifact@v4
        with:
          name: pytest-reports
          path: |
            test-results.xml
            pytest-report.html

  # =====================================================
  # COVERAGE STAGE - ensures minimum 75% coverage
  # =====================================================

# Generate HTML coverage folder (htmlcov/)
# Fail job if coverage < 75%

  coverage:
    name: Coverage Stage
    runs-on: ubuntu-latest
    needs: test
    env:
      USE_REAL_GRAMMAR: "false"
      GITHUB_ACTIONS: "true"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Cairo system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpng-dev pkg-config python3-dev

      - name: Install test dependencies
        run: pip install -r requirements.txt pytest pytest-cov

      - name: Generate Coverage Report (HTML + Branch)
        run: |
          pytest --cov=src --cov-branch --cov-report=html --cov-report=term --cov-fail-under=75

      - name: Upload Coverage HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov/


  # =====================================================
  # LINT STAGE - Python + JS linting, pylint â‰¥7.5 required
  # =====================================================

# Python linting using pylint
# Enforce pylint score >= 7.5 (quality gate)
# Run ESLint for frontend

  lint:
    name: Lint Stage
    runs-on: ubuntu-latest
    needs: coverage
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Python Lint ----------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Cairo system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpng-dev pkg-config python3-dev

      - name: Install project dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install pylint
        run: pip install pylint

      - name: Run pylint and enforce score â‰¥7.5
        run: |
          echo "Running pylint..."
          score=$(pylint src | tee pylint-report.txt | grep "rated at" | awk '{print $7}' | cut -d'/' -f1 | tr -d '[:space:]')
          echo "Pylint Score: $score"
          awk -v s="$score" 'BEGIN {if (s < 7.5) {print " Pylint score below 7.5 threshold. Failing pipeline."; exit 1} else {print " Pylint check passed."}}'

      # ---------- JavaScript Lint ----------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: Upload Pylint Report
        uses: actions/upload-artifact@v4
        with:
          name: pylint-report
          path: pylint-report.txt


  # =========================================================
  # SECURITY SCAN STAGE - Bandit & Safety vulnerability checks
  # =========================================================

# Bandit: static security scan for Python code
# Fail pipeline if HIGH severity vulnerabilities found
# Safety: check python dependencies for CVEs

  security:
    name: Security Scan Stage
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Cairo system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libjpeg-dev libpng-dev pkg-config python3-dev

      - name: Install Security Tools
        run: pip install bandit safety

      - name: Run Bandit (Static Security Scan)
        run: bandit -r src -f json -o bandit-report.json --severity-level medium --confidence-level medium

      - name: Ensure Bandit Report Exists
        run: |
          if [ ! -f bandit-report.json ]; then
            echo '{}' > bandit-report.json
          fi

      - name: Check for Critical Vulnerabilities
        run: |
          if grep -q '"issue_severity": "HIGH"' bandit-report.json; then
            echo " Critical vulnerability found in Bandit scan. Failing pipeline."
            exit 1
          else
            echo " No critical vulnerabilities found."
          fi

      - name: Run Safety (Dependency Vulnerability Check)
        run: safety check --full-report > safety-report.txt
      
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.txt

  # =====================================================
  # DEPLOYMENT ARTIFACT STAGE - packages code + reports
  # =====================================================

# Runs only on main branch AND only if previous jobs pass
# Download frontend artifact from Build Stage
# Collect all reports: coverage, lint, security, test
# Package everything into deployment zip with date stamp
# Upload final deployment artifact for download

# =====================================================
  # DEPLOYMENT ARTIFACT STAGE - packages code + reports
  # =====================================================

  deploy:
    name: Deployment Artifact Stage
    runs-on: ubuntu-latest
    needs: [build, test, coverage, lint, security]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend-build-artifact/

      - name: Download Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: coverage-html
          path: htmlcov/

      - name: Download Pytest Reports
        uses: actions/download-artifact@v4
        with:
          name: pytest-reports
      
      - name: Download Security Reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          
      - name: Download Pylint Report
        uses: actions/download-artifact@v4
        with:
          name: pylint-report

      - name: Create Deployment Package
        run: |
          mkdir -p deployment/reports
          
          # âœ… Backend source code
          cp -r src/ deployment/
          
          # âœ… Frontend source code (complete)
          cp -r frontend/ deployment/frontend/
          
          # âœ… Frontend built/compiled output (for deployment)
          mkdir -p deployment/frontend/dist
          cp -r frontend-build-artifact/* deployment/frontend/dist/
          
          # âœ… All CI/CD reports
          cp -r htmlcov deployment/reports/htmlcov
          cp pylint-report.txt deployment/reports/
          cp bandit-report.json deployment/reports/
          cp safety-report.txt deployment/reports/
          cp pytest-report.html deployment/reports/
          cp test-results.xml deployment/reports/
          
          # âœ… Essential project files
          cp README.md requirements.txt deployment/
          
          # Create the zip with datestamp
          cd deployment
          zip -r ../deployment-package-$(date +%Y%m%d).zip .

      - name: Upload Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package-*.zip

      - name: Mark Completion
        run: |
          echo "âœ… Deployment artifact created successfully!"
          echo "ðŸ“¦ Package: deployment-package-$(date +%Y%m%d).zip"
          echo ""
          echo "ðŸ“‹ Artifact Contents:"
          echo "  - Backend source code (src/)"
          echo "  - Frontend source code (frontend/)"
          echo "  - Frontend built output (frontend/dist/)"
          echo "  - Coverage report (reports/htmlcov/)"
          echo "  - Lint report (reports/pylint-report.txt)"
          echo "  - Security reports (reports/bandit-report.json, safety-report.txt)"
          echo "  - Test results (reports/pytest-report.html, test-results.xml)"
          echo "  - Documentation (README.md)"
          echo "  - Dependencies (requirements.txt)"